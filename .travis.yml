language: node_js
node_js:
  - "6"

# Forces travis to use VM insted container, required to be able to build containers.
sudo: required

services:
    - docker

env:
    global:
        # Should be encrypted or set as private travis variables (in travis settings):
        # DOCKER_HUB_EMAIL
        # DOCKER_HUB_USERNAME
        # DOCKER_HUB_PASSWORD

        # Docker repository name
        - DOCKER_REPOSITORY="mendersoftware/gui"

addons:
    jwt:
        secure: "e7cOS+KUdda0jJ7LTAwCmDI3GpGYY3c7e4PnirjtYNYCvKpyTrpkRxK85o6lXUrZoyxd8RtuqwZoUzH0VFNBE0BjtThcaq+BQ5GW15scEPxZrutFPBJo+VT2M1YtzRYXKPeDgu28PL5tznmZUpuJ7EFgDJBPPNcV8HZnxQF7WnZkD0tb1z3iUBsThxi5Bvg/5B4YFgbfKQQw1WxfLKQNlBpxjuw+dDgDBvI0KGUUCZlyJ2DKw7E/rUyHf4VfYpa9gf78milIo1tKrpb4jBz0qw8OCo192f/yxDkP9JS+Ih2bfMTUPqyWyRpQVnpZ9Jh0qH4ZFteaAvJ2ARXFm2VR1bnc5hz3XCqDk9jgSBM//x1qKDs4ZNAj9Lsh+Ae+0TNyj1M4Xpbwjmtx5DQfdtXAFS2XXrkHqHkC0RQEql/BxqRtKPkil/kK+1JGoG2koz92/ExhRw7CWKMQdqGpupTwRwfkiMdTetlhO4s4N+whaLh7l1bfq9de9Yw4M9ZHes8Cj9I4xlV9LsO81ERLKPPKz3P0cnY6MEY2Jk9bku4xfQVLA+WufnM+SVwzDyTJuTTBvxY6M1Hb2Vboe3bDoHrPshPUHqPIILKjOPyZg7//Hyw9h8B66HC9az65UZfcy3iAB5N1s16gONZKRrMeu5cGaLjQG50BDceurzuorV/60oY="

notifications:
    webhooks:
        urls:
            - http://dev-gui.mender.io/notifications
        on_success: never
        on_failure: never
        on_start: always

before_script:
    - npm install -g gulp
    - npm install mocha selenium-webdriver@3.0.0-beta-2 saucelabs

    # Rename the branch we're on, so that it's not in the way for the
    # subsequent fetch. It's ok if this fails, it just means we're not on any
    # branch.
    - git branch -m temp-branch || true
    # Git trick: Fetch directly into our local branches instead of remote
    # branches.
    - git fetch origin 'refs/heads/*:refs/heads/*'
    # Get last remaining tags, if any.
    - git fetch --tags origin

    - git clone git://github.com/mendersoftware/mendertesting

script:
    # Check commit compliance.
    - mendertesting/check_commits.sh

    - gulp build
    # Make sure the test environment is running the pull request
    - if [ ${TRAVIS_PULL_REQUEST} = "false" ]; then export DEPLOY=$TRAVIS_BRANCH; else export DEPLOY=$TRAVIS_PULL_REQUEST; fi
    - for i in {1..60} ; do curl -s "http://dev-gui.mender.io/deploy/" | grep $DEPLOY; if [ $? -eq 0 ]; then break; else sleep 5; fi; done
    #- SAUCE_ACCESS_KEY=$SAUCE_ACCESS_KEY PLATFORM="linux" BROWSER="chrome" RUN_ON_SAUCELABS=true mocha tests/00_basic_test.js --timeout 0
    # Build docker image from docker file
    - sudo docker build -t $DOCKER_REPOSITORY .


before_deploy:
    # Master is always lastest
    - if [ ! -z "$TRAVIS_TAG" ]; then export IMAGE_TAG=$TRAVIS_TAG; else export IMAGE_TAG=$TRAVIS_BRANCH; fi
    - docker tag $DOCKER_REPOSITORY $DOCKER_REPOSITORY:$IMAGE_TAG

    # Upload image to docker registry only on PUSH
    - docker login --email=$DOCKER_HUB_EMAIL --username=$DOCKER_HUB_USERNAME --password=$DOCKER_HUB_PASSWORD

    - docker push $DOCKER_REPOSITORY:$IMAGE_TAG


deploy:
    # Force before_deploy for branches
    -
        provider: script
        script: /bin/true
        on:
            all_branches: true

    # Force before_deploy for tags
    -
        provider: script
        script: /bin/true
        on:
            tags: true
            all_branches: true
